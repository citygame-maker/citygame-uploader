<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>n8n Game Sender | Kokimoki Game Upload</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 512'><path d='M480 96H160C71.6 96 0 167.6 0 256s71.6 160 160 160c44.8 0 85.2-18.4 114.2-48h91.5c29 29.6 69.5 48 114.2 48 88.4 0 160-71.6 160-160S568.4 96 480 96zM256 276c-15.5 0-28-12.5-28-28s12.5-28 28-28 28 12.5 28 28-12.5 28-28 28zm128 0c-15.5 0-28-12.5-28-28s12.5-28 28-28 28 12.5 28 28-12.5 28-28 28z' fill='white'/></svg>" type="image/svg+xml">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    :root {
      --primary: #0ea5e9;
      --primary-dark: #0284c7;
      --secondary: #8b5cf6;
      --dark-bg: #0f172a;
      --darker-bg: #020617;
      --card-bg: rgba(15, 23, 42, 0.85);
      --card-border: rgba(148, 163, 184, 0.2);
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
    }

    body {
      margin: 0;
      padding: 0;
      background:
        linear-gradient(rgba(2, 6, 23, 0.78), rgba(2, 6, 23, 0.78)),
        url("https://trello-backgrounds.s3.amazonaws.com/66d6bb87a0b30e32c038c240/1920x1080/82cebc0c014226d323d253376e883cb3/Workshop_Phase_3_%282%29.webp");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 80%, rgba(56, 189, 248, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .app-root, .full-screen-center {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .panel {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: 32px;
      border: 1px solid var(--card-border);
      box-shadow: 0 20px 60px rgba(2, 6, 23, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.05);
      width: 100%;
      max-width: 780px;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .panel:hover {
      box-shadow: 0 25px 70px rgba(2, 6, 23, 0.9), 0 0 0 1px rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
    }

    .header { margin-bottom: 20px; }

    h1 {
      font-size: 2rem;
      margin: 0 0 8px;
      background: linear-gradient(90deg, #f8fafc, #cbd5e1);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .subheading {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 18px;
      line-height: 1.6;
    }

    .tag-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 14px 0 18px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      padding: 6px 14px;
      border-radius: 50px;
      background: rgba(30, 41, 59, 0.7);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
      transition: all 0.2s ease;
    }

    .tag i { font-size: 0.8rem; color: var(--primary); }

    .tag:hover {
      background: rgba(30, 41, 59, 0.9);
      border-color: var(--primary);
      transform: translateY(-1px);
    }

    .info-box {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 18px;
      padding: 14px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .info-box i { color: var(--primary); }

    .field { margin-bottom: 22px; }

    label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    label i { color: var(--primary); font-size: 0.85rem; }

    input[type="text"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      padding: 14px 16px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(71, 85, 105, 0.5);
      background: rgba(15, 23, 42, 0.7);
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
      background: rgba(15, 23, 42, 0.9);
    }

    textarea {
      min-height: 140px;
      resize: vertical;
      line-height: 1.5;
      font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
    }

    .btn-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 30px;
      flex-wrap: wrap;
      gap: 16px;
    }

    button {
      border: none;
      border-radius: var(--radius-md);
      padding: 14px 28px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
      background: linear-gradient(135deg, var(--primary-dark), #0369a1);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: rgba(71, 85, 105, 0.5);
      box-shadow: none;
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(71, 85, 105, 0.7);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .status {
      font-size: 0.9rem;
      font-weight: 500;
      padding: 10px 16px;
      border-radius: var(--radius-md);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 200px;
    }

    .status.error {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
      border-left: 3px solid var(--error);
    }

    .status.success {
      background: rgba(16, 185, 129, 0.15);
      color: #a7f3d0;
      border-left: 3px solid var(--success);
    }

    .status.info {
      background: rgba(14, 165, 233, 0.15);
      color: #bae6fd;
      border-left: 3px solid var(--primary);
    }

    .auth-title {
      font-size: 1.8rem;
      margin: 0 0 12px;
      background: linear-gradient(90deg, #f8fafc, #cbd5e1);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
      text-align: center;
    }

    .auth-note {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 28px;
      text-align: center;
      line-height: 1.6;
    }

    .auth-error {
      font-size: 0.9rem;
      color: var(--error);
      margin-top: 10px;
      padding: 10px 14px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--error);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .logo-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 6px 20px rgba(14, 165, 233, 0.3);
      flex-shrink: 0;
    }

    .footer {
      margin-top: 32px;
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-muted);
      padding-top: 20px;
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin: 6px 0 18px;
      padding: 6px;
      background: rgba(2, 6, 23, 0.35);
      border: 1px solid rgba(148, 163, 184, 0.16);
      border-radius: 999px;
      width: fit-content;
    }

    .tab {
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: rgba(30, 41, 59, 0.45);
      color: var(--text-secondary);
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      user-select: none;
    }

    .tab:hover {
      transform: translateY(-1px);
      border-color: rgba(14, 165, 233, 0.6);
      color: var(--text-primary);
      background: rgba(30, 41, 59, 0.65);
    }

    .tab.active {
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.35), rgba(139, 92, 246, 0.25));
      border-color: rgba(14, 165, 233, 0.75);
      color: var(--text-primary);
      box-shadow: 0 6px 18px rgba(14, 165, 233, 0.18);
    }

    .mode-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .mode-toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .mode-toggle-switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 26px;
    }

    .mode-toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .mode-toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: rgba(71, 85, 105, 0.5);
      transition: all 0.3s ease;
      border-radius: 34px;
    }

    .mode-toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: transform 0.3s ease;
      border-radius: 50%;
    }

    input:checked + .mode-toggle-slider {
      background-color: var(--warning);
    }

    input:checked + .mode-toggle-slider:before {
      transform: translateX(26px);
    }

    .mode-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      padding: 6px 14px;
      border-radius: 50px;
      transition: all 0.2s ease;
    }

    .mode-status.test {
      background: rgba(245, 158, 11, 0.15);
      color: #fcd34d;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .mode-status.prod {
      background: rgba(16, 185, 129, 0.15);
      color: #a7f3d0;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    @media (max-width: 768px) {
      .panel { padding: 24px 20px; }
      h1 { font-size: 1.7rem; }
      .btn-row { flex-direction: column; align-items: stretch; }
      .status { min-width: 100%; justify-content: center; }
      .mode-toggle { flex-wrap: wrap; }
    }

    @media (max-width: 480px) {
      .panel { padding: 20px 16px; border-radius: 12px; }
      h1 { font-size: 1.5rem; }
      .auth-title { font-size: 1.5rem; }
      button { width: 100%; }
      .tabs { width: 100%; }
      .tab { width: 100%; justify-content: center; }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .field, .btn-row, .header, .info-box, .tabs, .mode-toggle {
      animation: slideUp 0.5s ease-out;
    }
  </style>
</head>

<body>
  <div id="app">
    <div v-if="!isAuthed" class="full-screen-center">
      <div class="panel">
        <div class="logo" style="justify-content:center;">
          <div class="logo-icon">
            <i class="fas fa-lock"></i>
          </div>
        </div>

        <h2 class="auth-title">Secure Access Required</h2>
        <p class="auth-note">
          <i class="fas fa-shield-alt"></i> This page is password-protected. Please enter the shared password to continue.
        </p>

        <div class="field">
          <label for="password"><i class="fas fa-key"></i> Password</label>
          <input
            id="password"
            type="password"
            v-model="passwordInput"
            @keyup.enter="checkPassword"
            autocomplete="off"
            placeholder="Enter access password"
          />
        </div>

        <div class="btn-row">
          <button type="button" @click="checkPassword" :disabled="authLoading">
            <i class="fas fa-unlock-alt"></i>
            <span>{{ authLoading ? 'Checking…' : 'Unlock Portal' }}</span>
          </button>

          <div v-if="authError" class="auth-error">
            <i class="fas fa-exclamation-circle"></i> {{ authError }}
          </div>
        </div>

        <div class="footer">
          <p><i class="fas fa-info-circle"></i> Contact the maintainer if you don't have the password</p>
        </div>
      </div>
    </div>

    <div v-else class="app-root">
      <div class="panel">
        <div class="header">
          <div class="logo">
            <div class="logo-icon">
              <i class="fas fa-gamepad"></i>
            </div>
            <div>
              <h1>n8n Game Sender</h1>
              <div class="subheading">Upload game configurations to n8n workflow</div>
            </div>
          </div>

          <div class="mode-toggle">
            <div class="mode-toggle-label">
              <i class="fas fa-flask"></i>
              <span>Testing Mode:</span>
            </div>
            <label class="mode-toggle-switch">
              <input type="checkbox" v-model="isTestingMode" @change="toggleTestingMode">
              <span class="mode-toggle-slider"></span>
            </label>
            <div class="mode-status" :class="isTestingMode ? 'test' : 'prod'">
              <i :class="isTestingMode ? 'fas fa-flask' : 'fas fa-rocket'"></i>
              <span>{{ isTestingMode ? 'Testing Mode' : 'Production Mode' }}</span>
            </div>
          </div>

          <div class="tabs">
            <div class="tab" :class="{active: activeTab==='upload'}" @click="activeTab='upload'">
              <i class="fas fa-cloud-upload-alt"></i> Bokun
            </div>
            <div :style="{
    pointerEvents: 'none',
    opacity: '0.5',
    cursor: 'not-allowed'
  }" class="tab" :class="{active: activeTab==='migrate'}">
              <i class="fas fa-right-left"></i> Migrate
            </div>
          </div>
        </div>

        <div class="info-box" v-if="activeTab==='upload'">
          <i class="fas fa-link"></i>
          <div>
            <strong>Webhook Endpoint:</strong> {{ currentWebhookUrl }}
            <span style="margin-left: 8px; font-size: 0.8rem;" :class="isTestingMode ? 'test' : 'prod'">
              <i :class="isTestingMode ? 'fas fa-flask' : 'fas fa-rocket'"></i>
              {{ isTestingMode ? 'Testing' : 'Production' }}
            </span>
          </div>
        </div>

        <div class="info-box" v-else>
          <i class="fas fa-link"></i>
          <div>
            <strong>Migrate Webhook:</strong> {{ currentMigrateWebhookUrl }}
            <span style="margin-left: 8px; font-size: 0.8rem;" :class="isTestingMode ? 'test' : 'prod'">
              <i :class="isTestingMode ? 'fas fa-flask' : 'fas fa-rocket'"></i>
              {{ isTestingMode ? 'Testing' : 'Production' }}
            </span>
          </div>
        </div>

        <form v-if="activeTab==='upload'" @submit.prevent="handleSubmit">
          <div class="field">
            <label for="configYaml"><i class="fas fa-cog"></i> config.yml Content<span style="color: #ef4444;">*</span></label>
            <textarea required
              id="configYaml"
              v-model="configYaml"
              placeholder="# Paste your Kokimoki config.yml here
title: Dumaguete
sequences:
# ..."
            ></textarea>
          </div>

          <div class="field">
            <label for="gameCode"><i class="fas fa-code"></i> Game Code<span style="color: #ef4444;">*</span></label>
            <textarea required
              id="gameCode"
              v-model="gameCode"
              placeholder="// Paste your game code from Apps > latest code
69426a65a720e0d9d89****..."
            ></textarea>
          </div>

          <div class="btn-row">
            <button type="submit" :disabled="isSubmitting || !canSubmit">
              <i class="fas fa-paper-plane"></i>
              <span>{{ isSubmitting ? 'Sending to n8n…' : 'Send to n8n' }}</span>
            </button>

            <button type="button" class="btn-secondary" @click="resetForm" :disabled="isSubmitting">
              <i class="fas fa-eraser"></i> Clear
            </button>

            <div
              class="status"
              :class="{ error: lastError, success: lastSuccessMessage, info: !lastError && !lastSuccessMessage && statusMessage }"
              v-if="statusMessage"
            >
              <i :class="lastError ? 'fas fa-exclamation-circle' : lastSuccessMessage ? 'fas fa-check-circle' : 'fas fa-info-circle'"></i>
              {{ statusMessage }}
            </div>
          </div>
        </form>

        <form v-else @submit.prevent="handleMigrate">
          <div class="field">
            <label for="mConfigYaml"><i class="fas fa-cog"></i> config.yml Content</label>
            <textarea id="mConfigYaml" v-model="migrateConfigYaml" placeholder="# Paste your Kokimoki config.yml here"></textarea>
          </div>

          <div class="field">
            <label for="loquizId"><i class="fas fa-cog"></i> Loquiz ID</label>
            <input id="loquizId" type="text" v-model.trim="loquizId" placeholder="e.g. F3EUSZJCJC" />
          </div>

          <div class="field">
            <label for="bokunId"><i class="fas fa-ticket"></i> Bokun ID<span style="color: #ef4444;">*</span></label>
            <input required id="bokunId" type="text" v-model.trim="bokunId" placeholder="e.g. 67890" />
          </div>

          <div class="field">
            <label for="concept"><i class="fas fa-lightbulb"></i> Game Concept<span style="color: #ef4444;">*</span></label>
            <select required id="concept" v-model="gameConcept">
              <option :value="36">Secrets</option>
              <option :value="38">Sherlock</option>
              <option :value="37">Syndicate</option>
            </select>
          </div>

          <div class="btn-row">
            <button type="submit" :disabled="isMigrateSubmitting || !canMigrateSubmit">
              <i class="fas fa-right-left"></i>
              <span>{{ isMigrateSubmitting ? 'Sending migrate…' : 'Run Migrate' }}</span>
            </button>

            <button type="button" class="btn-secondary" @click="resetMigrateForm" :disabled="isMigrateSubmitting">
              <i class="fas fa-eraser"></i> Clear
            </button>

            <div
              class="status"
              :class="{ error: migrateLastError, success: migrateLastSuccess, info: !migrateLastError && !migrateLastSuccess && migrateStatusMessage }"
              v-if="migrateStatusMessage"
            >
              <i :class="migrateLastError ? 'fas fa-exclamation-circle' : migrateLastSuccess ? 'fas fa-check-circle' : 'fas fa-info-circle'"></i>
              {{ migrateStatusMessage }}
            </div>
          </div>
        </form>

        <div class="footer">
          <p><i class="fas fa-user"></i> By Philip</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted } = Vue;

    // Only the auth endpoint is hardcoded — all webhook URLs are returned by the server on login
    const PASSWORD_CHECK_URL = "https://citygame.app.n8n.cloud/webhook/validate-pass";

    createApp({
      setup() {
        const isTestingMode = ref(true);

        // Webhook URLs — populated from server response on successful auth
        const webhookUrls = ref({
          test_upload:   null,
          prod_upload:   null,
          test_migrate:  null,
          prod_migrate:  null
        });

        onMounted(() => {
          const savedMode = localStorage.getItem('n8nGameSender_testingMode');
          if (savedMode !== null) {
            isTestingMode.value = savedMode === 'true';
          }
        });

        const currentWebhookUrl = computed(() =>
          isTestingMode.value ? webhookUrls.value.test_upload : webhookUrls.value.prod_upload
        );

        const currentMigrateWebhookUrl = computed(() =>
          isTestingMode.value ? webhookUrls.value.test_migrate : webhookUrls.value.prod_migrate
        );

        const toggleTestingMode = () => {
          localStorage.setItem('n8nGameSender_testingMode', isTestingMode.value);
          const mode = isTestingMode.value ? 'Testing' : 'Production';
          alert(`Switched to ${mode} Mode\n\nUpload: ${currentWebhookUrl.value}\nMigrate: ${currentMigrateWebhookUrl.value}`);
        };

        const activeTab = ref("upload");

        const isAuthed = ref(false);
        const passwordInput = ref("");
        const authError = ref("");
        const authLoading = ref(false);

        const title = ref("");
        const gameCode = ref("");
        const configYaml = ref("");
        const isSubmitting = ref(false);
        const statusMessage = ref("");
        const lastError = ref(false);
        const lastSuccessMessage = ref(false);

        const canSubmit = computed(() =>
          gameCode.value && configYaml.value
        );

        const migrateConfigYaml = ref("");
        const sharepointImagesUrls = ref([""]);
        const wordpressEventId = ref("");
        const loquizId = ref("");
        const bokunId = ref("");
        const gameConcept = ref(36);
        const isMigrateSubmitting = ref(false);
        const migrateStatusMessage = ref("");
        const migrateLastError = ref(false);
        const migrateLastSuccess = ref(false);

        const canMigrateSubmit = computed(() =>
          !!bokunId.value && !!gameConcept.value
        );

        // ---------------------------------------------------------------------------
        // Auth — server returns webhook URLs on success
        // Expected response shape (when password is correct):
        //   {
        //     "valid": true,
        //     "urls": {
        //       "test_upload":  "https://...",
        //       "prod_upload":  "https://...",
        //       "test_migrate": "https://...",
        //       "prod_migrate": "https://..."
        //     }
        //   }
        // ---------------------------------------------------------------------------
        const checkPassword = async () => {
          authError.value = "";

          if (!passwordInput.value) {
            authError.value = "Please enter the password.";
            return;
          }

          authLoading.value = true;

          try {
            const res = await fetch(PASSWORD_CHECK_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password: passwordInput.value })
            });

            if (!res.ok) throw new Error(`Server returned ${res.status}`);

            // Try to parse as JSON first (new behaviour); fall back to plain "1" (legacy)
            const contentType = res.headers.get("content-type") || "";
            let isValid = false;

            if (contentType.includes("application/json")) {
              const data = await res.json();

              if (data.valid === true) {
                isValid = true;

                // Populate webhook URLs from server response
                if (data.urls) {
                  webhookUrls.value = {
                    test_upload:  data.urls.test_upload  || "",
                    prod_upload:  data.urls.prod_upload  || "",
                    test_migrate: data.urls.test_migrate || "",
                    prod_migrate: data.urls.prod_migrate || ""
                  };
                }
              }
            } else {
              // Legacy plain-text "1" response — no URLs provided
              const text = await res.text();
              if (text.trim() === "1") {
                isValid = true;
                // Warn in console; app won't function without URLs
                console.warn("Auth server returned legacy plain-text response. Webhook URLs were not provided.");
              }
            }

            if (isValid) {
              isAuthed.value = true;
              authError.value = "";
              passwordInput.value = "";
            } else {
              authError.value = "Incorrect password.";
            }
          } catch (err) {
            console.error(err);
            authError.value = "Error contacting server. Please try again.";
          } finally {
            authLoading.value = false;
          }
        };

        const resetForm = () => {
          title.value = "";
          gameCode.value = "";
          configYaml.value = "";
          statusMessage.value = "";
          lastError.value = false;
          lastSuccessMessage.value = false;
        };

        const resetMigrateForm = () => {
          migrateConfigYaml.value = "";
          sharepointImagesUrls.value = [""];
          wordpressEventId.value = "";
          bokunId.value = "";
          loquizId.value = "";
          gameConcept.value = 36;
          migrateStatusMessage.value = "";
          migrateLastError.value = false;
          migrateLastSuccess.value = false;
        };

        const handleSubmit = async () => {
          if (!canSubmit.value || isSubmitting.value) return;

          if (!currentWebhookUrl.value) {
            statusMessage.value = "Webhook URL not available. Please re-authenticate.";
            lastError.value = true;
            return;
          }

          isSubmitting.value = true;
          statusMessage.value = "Sending to n8n…";
          lastError.value = false;
          lastSuccessMessage.value = false;

          try {
            const res = await fetch(currentWebhookUrl.value, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                title: title.value,
                game_code: gameCode.value,
                config_yaml: configYaml.value
              })
            });

            let data = {};
            try { data = await res.json(); } catch (e) { data = {}; }

            if (!res.ok) throw new Error(`Server returned ${res.status}`);

            const mode = isTestingMode.value ? 'Testing' : 'Production';
            alert(`Successfully sent to n8n!\n\nMode: ${mode}\nCheck Bokun in about 3 minutes.`);
            statusMessage.value = data.message || `Sent to n8n (${mode}). Check Bokun in ~3 minutes.`;
            lastSuccessMessage.value = true;

            setTimeout(resetForm, 3000);
          } catch (err) {
            console.error(err);
            statusMessage.value = `Failed to send: ${err.message}`;
            lastError.value = true;
          } finally {
            isSubmitting.value = false;
          }
        };

        const handleMigrate = async () => {
          if (!canMigrateSubmit.value || isMigrateSubmitting.value) return;

          if (!currentMigrateWebhookUrl.value) {
            migrateStatusMessage.value = "Migrate URL not available. Please re-authenticate.";
            migrateLastError.value = true;
            return;
          }

          isMigrateSubmitting.value = true;
          migrateStatusMessage.value = "Sending migrate…";
          migrateLastError.value = false;
          migrateLastSuccess.value = false;

          try {
            const urls = sharepointImagesUrls.value
              .map(u => (u || "").trim())
              .filter(Boolean);

            const res = await fetch(currentMigrateWebhookUrl.value, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                config_yaml: migrateConfigYaml.value,
                sharepoint_images_urls: urls,
                wordpress_event_id: wordpressEventId.value,
                bokun_id: bokunId.value,
                loquiz_id: loquizId.value,
                game_concept: gameConcept.value
              })
            });

            let data = {};
            try { data = await res.json(); } catch (e) { data = {}; }

            if (!res.ok) throw new Error(`Server returned ${res.status}`);

            const mode = isTestingMode.value ? 'Testing' : 'Production';
            alert(`Migrate request sent!\n\nMode: ${mode}\nCheck Bokun in about 3 minutes.`);
            migrateStatusMessage.value = data.message || `Migrate sent (${mode}). Check Bokun in ~3 minutes.`;
            migrateLastSuccess.value = true;

            setTimeout(resetMigrateForm, 3000);
          } catch (err) {
            console.error(err);
            migrateStatusMessage.value = `Failed to migrate: ${err.message}`;
            migrateLastError.value = true;
          } finally {
            isMigrateSubmitting.value = false;
          }
        };

        return {
          isTestingMode,
          currentWebhookUrl,
          currentMigrateWebhookUrl,
          toggleTestingMode,
          activeTab,
          isAuthed,
          passwordInput,
          authError,
          authLoading,
          checkPassword,
          title,
          gameCode,
          configYaml,
          isSubmitting,
          statusMessage,
          lastError,
          lastSuccessMessage,
          canSubmit,
          handleSubmit,
          resetForm,
          migrateConfigYaml,
          sharepointImagesUrls,
          wordpressEventId,
          bokunId,
          loquizId,
          gameConcept,
          isMigrateSubmitting,
          migrateStatusMessage,
          migrateLastError,
          migrateLastSuccess,
          canMigrateSubmit,
          handleMigrate,
          resetMigrateForm
        };
      }
    }).mount("#app");
  </script>
</body>
</html>
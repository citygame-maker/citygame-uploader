<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>n8n Game Sender (Simple)</title>
  <!-- Vue 3 from CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background:
        linear-gradient(
          rgba(2, 6, 23, 0.78),
          rgba(2, 6, 23, 0.78)
        ),
        url("https://trello-backgrounds.s3.amazonaws.com/66d6bb87a0b30e32c038c240/1920x1080/82cebc0c014226d323d253376e883cb3/Workshop_Phase_3_%282%29.webp");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: #e5e7eb;
    }


    .full-screen-center {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .app-root {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .panel {
      background: #020617;
      border-radius: 16px;
      padding: 22px 22px 20px;
      border: 1px solid #1e293b;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.75);
      width: 100%;
      max-width: 720px;
    }

    h1 {
      font-size: 1.6rem;
      margin: 0 0 6px;
    }

    .subheading {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 18px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #e5e7eb;
    }

    input[type="text"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    textarea:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.3);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.4;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .field {
      margin-bottom: 14px;
    }

    .btn-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      /* background: linear-gradient(135deg, #22c55e, #16a34a); */
      color: white;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      background: linear-gradient(135deg, #2dd4bf, #14b8a6);
    }
    input[type="text"]:focus,
      input[type="password"]:focus,
      textarea:focus {
        outline: none;
        border-color: #2dd4bf;
        box-shadow: 0 0 0 1px rgba(45, 212, 191, 0.35);
      }


    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .status {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .status.error {
      color: #f97373;
    }

    .status.success {
      color: #2dd4bf;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.12);
      color: #9ca3af;
    }

    .webhook-hint {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    .auth-title {
      font-size: 1.4rem;
      margin: 0 0 8px;
    }

    .auth-note {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 14px;
    }

    .auth-error {
      font-size: 0.8rem;
      color: #f97373;
      margin-top: 6px;
    }

    @media (max-width: 640px) {
      .panel {
        padding: 18px 16px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- PASSWORD GATE -->
    <div v-if="!isAuthed" class="full-screen-center">
      <div class="panel">
        <h2 class="auth-title">Enter Access Password</h2>
        <p class="auth-note">
          This page is restricted. Ask the maintainer for the shared password.
        </p>

        <div class="field">
          <label for="password">Password</label>
          <input
            id="password"
            type="password"
            v-model="passwordInput"
            @keyup.enter="checkPassword"
            autocomplete="off"
          />
        </div>

        <div class="btn-row">
          <button type="button" @click="checkPassword" :disabled="authLoading">
            <span v-if="authLoading">Checkingâ€¦</span>
            <span v-else>Unlock</span>
          </button>
          <div v-if="authError" class="auth-error">
            {{ authError }}
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN APP (only visible after password) -->
    <div v-else class="app-root">
      <div class="panel">
        <h1>Game Upload to n8n</h1>
        <div class="subheading">
          <p>By Philip</p>
          Send a <span class="tag">config.yml (pasted)</span> and a <span class="tag">game code</span> payload into your n8n workflow.
        </div>

        <div class="webhook-hint">
          <strong>Webhook:</strong> {{ webhookUrl }}
        </div>

        <form @submit.prevent="handleSubmit">
          <div class="field">
            <label for="title">Game City Name</label>
            <input
              id="title"
              type="text"
              v-model.trim="title"
              placeholder="e.g. Dumaguete"
            />
          </div>

          <div class="field">
            <label for="configYaml">config.yml Content</label>
            <textarea
              id="configYaml"
              v-model="configYaml"
              placeholder="# Paste your Kokimoki config here"
            ></textarea>
          </div>

          <div class="field">
            <label for="gameCode">Game Code</label>
            <textarea
              id="gameCode"
              v-model="gameCode"
              placeholder="// Apps > latest code"
            ></textarea>
          </div>

          <div class="btn-row">
            <button type="submit" :disabled="isSubmitting || !canSubmit">
              <span v-if="isSubmitting">Sendingâ€¦</span>
              <span v-else>Send to n8n</span>
            </button>
            <div
              class="status"
              :class="{ error: lastError, success: lastSuccessMessage }"
              v-if="statusMessage"
            >
              {{ statusMessage }}
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed } = Vue;

    // ðŸ”— Your n8n endpoints
    const webhookUrlConst      = "https://citygame.app.n8n.cloud/webhook-test/game-upload";
    const passwordCheckUrlConst = "https://citygame.app.n8n.cloud/webhook/validate-pass";

    createApp({
      setup() {
        // Auth state
        const isAuthed = ref(false);
        const passwordInput = ref("");
        const authError = ref("");
        const authLoading = ref(false);

        // Form state
        const webhookUrl = ref(webhookUrlConst);
        const title = ref("");
        const gameCode = ref("");
        const configYaml = ref("");
        const isSubmitting = ref(false);
        const statusMessage = ref("");
        const lastError = ref(false);
        const lastSuccessMessage = ref(false);

        const canSubmit = computed(() => {
          return title.value && gameCode.value && configYaml.value;
        });

        // âœ… Password validation via n8n (returns "1" or "0" in body)
        async function checkPassword() {
          authError.value = "";

          if (!passwordInput.value) {
            authError.value = "Please enter the password.";
            return;
          }

          authLoading.value = true;

          try {
            const res = await fetch(passwordCheckUrlConst, {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ password: passwordInput.value })
            });

            const text = await res.text();
            if (!res.ok) {
              throw new Error("n8n returned " + res.status + " (" + text + ")");
            }

            const trimmed = (text || "").trim();

            if (trimmed === "1") {
              isAuthed.value = true;
              authError.value = "";
              passwordInput.value = "";
            } else {
              authError.value = "Incorrect password.";
            }
          } catch (err) {
            console.error(err);
            authError.value = "Error contacting password server. Try again.";
          } finally {
            authLoading.value = false;
          }
        }

        async function handleSubmit() {
          if (!canSubmit.value || isSubmitting.value) return;

          isSubmitting.value = true;
          statusMessage.value = "Sending to n8nâ€¦";
          lastError.value = false;
          lastSuccessMessage.value = false;

          try {
            const payload = {
              title: title.value,
              game_code: gameCode.value,
              config_yaml: configYaml.value
            };

            const response = await fetch(webhookUrl.value, {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify(payload)
            });

            // Try to parse JSON, but don't depend on it
            let data = {};
            try {
              data = await response.json();
            } catch (e) {
              data = {};
            }

            if (!response.ok) {
              throw new Error("n8n returned " + response.status);
            }

            // Show popup window-like alert
            alert("Sent to n8n âœ…\n\nCheck Bokun in about 3 minutes.");

            statusMessage.value = data.message || "Sent to n8n. Check Bokun in ~3 minutes.";
            lastSuccessMessage.value = true;

            // Reset form
            title.value = "";
            gameCode.value = "";
            configYaml.value = "";
          } catch (err) {
            console.error(err);
            statusMessage.value = "Failed to send: " + err.message;
            lastError.value = true;
          } finally {
            isSubmitting.value = false;
          }
        }

        return {
          // auth
          isAuthed,
          passwordInput,
          authError,
          authLoading,
          checkPassword,

          // form
          webhookUrl,
          title,
          gameCode,
          configYaml,
          isSubmitting,
          statusMessage,
          lastError,
          lastSuccessMessage,
          canSubmit,
          handleSubmit
        };
      }
    }).mount("#app");
  </script>
</body>
</html>
